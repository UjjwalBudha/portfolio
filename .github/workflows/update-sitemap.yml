name: Update Sitemap

on:
  push:
    branches:
      - main
    paths:
      - 'blogs/*.html'
      - 'index.html'

jobs:
  update-sitemap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate sitemap
        run: |
          cat > sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
                  xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"
                  xmlns:xhtml="http://www.w3.org/1999/xhtml"
                  xmlns:mobile="http://www.google.com/schemas/sitemap-mobile/1.0"
                  xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"
                  xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">
            
            <!-- Homepage -->
            <url>
              <loc>https://ujwalbudha.com.np/</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
            
            <!-- Blog Posts -->
          EOF
          
          # Find all blog HTML files and add them to sitemap
          for file in blogs/*.html; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lastmod=$(date -r "$file" +%Y-%m-%d)
              echo "    <url>" >> sitemap.xml
              echo "      <loc>https://ujwalbudha.com.np/blogs/$filename</loc>" >> sitemap.xml
              echo "      <lastmod>$lastmod</lastmod>" >> sitemap.xml
              echo "      <changefreq>monthly</changefreq>" >> sitemap.xml
              echo "      <priority>0.8</priority>" >> sitemap.xml
              echo "    </url>" >> sitemap.xml
            fi
          done
          
          # Add other pages
          echo "    <!-- Other Pages -->" >> sitemap.xml
          echo "    <url>" >> sitemap.xml
          echo "      <loc>https://ujwalbudha.com.np/portfolio-details.html</loc>" >> sitemap.xml
          echo "      <lastmod>$(date +%Y-%m-%d)</lastmod>" >> sitemap.xml
          echo "      <changefreq>monthly</changefreq>" >> sitemap.xml
          echo "      <priority>0.6</priority>" >> sitemap.xml
          echo "    </url>" >> sitemap.xml
          echo "  </urlset>" >> sitemap.xml
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add sitemap.xml
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update sitemap [skip ci]" && git push)
      
      - name: Ping Google
        run: |
          curl "https://www.google.com/ping?sitemap=https://ujwalbudha.com.np/sitemap.xml" || true
      
      - name: Ping Bing
        run: |
          curl "https://www.bing.com/ping?sitemap=https://ujwalbudha.com.np/sitemap.xml" || true
